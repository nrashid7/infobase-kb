{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://infobase.gov.bd/schemas/kb-v3.json",
  "title": "Bangladesh Government Services Knowledge Base - Guide-First Schema v3.0",
  "description": "Extends v2.0 provenance-first KB with a guide layer: service_guides provide user-friendly, step-by-step guidance while claims + source_pages remain the audit backbone",
  "type": "object",
  "required": [
    "$schema_version",
    "data_version",
    "last_updated_at",
    "source_pages",
    "claims",
    "agencies",
    "documents",
    "services",
    "service_guides"
  ],
  "properties": {
    "$schema_version": {
      "type": "string",
      "const": "3.0.0",
      "description": "Schema version - must be 3.0.0 for guide-first model"
    },
    "data_version": {
      "type": "integer",
      "minimum": 1,
      "description": "Monotonically increasing data version number"
    },
    "last_updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last update"
    },
    "updated_by": {
      "type": "string",
      "description": "Identifier of entity/system that made the update"
    },
    "change_log": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["version", "date", "changes"],
        "properties": {
          "version": { "type": "integer" },
          "date": { "type": "string", "format": "date" },
          "changes": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "audit_log": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["event_id", "event_type", "timestamp", "affected_entities", "actor"],
        "additionalProperties": false,
        "properties": {
          "event_id": {
            "type": "string",
            "pattern": "^evt\\.[a-f0-9]{40}$",
            "description": "Deterministic event ID: evt. + SHA1(event_type + timestamp + JSON(affected_entities))"
          },
          "event_type": {
            "type": "string",
            "enum": ["source_change", "claim_invalidation", "verification", "migration", "guide_update"],
            "description": "Type of audit event (v3 adds guide_update)"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when the event occurred"
          },
          "affected_entities": {
            "type": "object",
            "required": [],
            "additionalProperties": false,
            "properties": {
              "source_pages": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^source\\.[a-f0-9]{40}$"
                }
              },
              "claims": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^claim\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$"
                }
              },
              "services": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^svc\\.[a-z0-9_]+$"
                }
              },
              "documents": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^doc\\.[a-z0-9_]+$"
                }
              },
              "agencies": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^agency\\.[a-z0-9_]+$"
                }
              },
              "service_guides": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^guide\\.[a-z0-9_]+$"
                },
                "description": "Guide IDs affected by this event (v3)"
              }
            }
          },
          "actor": {
            "type": "string",
            "pattern": "^(system|user|script:[a-zA-Z0-9_\\-\\.]+)$"
          },
          "description": { "type": "string" },
          "metadata": {
            "type": "object",
            "properties": {
              "hash_before": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
              "hash_after": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
              "migration_source": { "type": "string" },
              "schema_version_from": { "type": "string" },
              "schema_version_to": { "type": "string" }
            }
          }
        }
      }
    },
    "source_pages": {
      "type": "array",
      "description": "Global registry of all government source pages - unchanged from v2",
      "items": {
        "type": "object",
        "required": [
          "source_page_id",
          "canonical_url",
          "agency_id",
          "page_type",
          "language",
          "content_hash",
          "last_crawled_at"
        ],
        "properties": {
          "source_page_id": {
            "type": "string",
            "pattern": "^source\\.[a-f0-9]{40}$"
          },
          "canonical_url": {
            "type": "string",
            "format": "uri"
          },
          "agency_id": {
            "type": "string",
            "pattern": "^agency\\.[a-z0-9_]+$"
          },
          "page_type": {
            "enum": ["main_portal", "instruction", "fee_schedule", "form", "notice", "regulation", "other"]
          },
          "title": { "type": "string" },
          "language": {
            "type": "array",
            "items": { "enum": ["bn", "en"] },
            "minItems": 1
          },
          "crawl_method": {
            "enum": ["html_static", "html_dynamic", "pdf", "api", "manual"]
          },
          "last_crawled_at": {
            "type": "string",
            "format": "date-time"
          },
          "content_hash": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$"
          },
          "previous_hash": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$"
          },
          "snapshot_ref": { "type": "string" },
          "extracted_text_ref": { "type": "string" },
          "change_log": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["detected_at", "hash_before", "hash_after"],
              "properties": {
                "detected_at": { "type": "string", "format": "date-time" },
                "hash_before": { "type": "string" },
                "hash_after": { "type": "string" },
                "notes": { "type": "string" }
              }
            }
          },
          "status": {
            "enum": ["active", "archived", "broken", "deprecated"]
          },
          "notes": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "claims": {
      "type": "array",
      "description": "Atomic claims - unchanged from v2",
      "items": {
        "type": "object",
        "required": [
          "claim_id",
          "entity_ref",
          "claim_type",
          "text",
          "citations",
          "status"
        ],
        "properties": {
          "claim_id": {
            "type": "string",
            "pattern": "^claim\\.(fee|step|doc|portal|eligibility|processing_time|rule|condition|definition|location|contact_info|other)\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$"
          },
          "entity_ref": {
            "type": "object",
            "required": ["type", "id"],
            "properties": {
              "type": { "enum": ["service", "document"] },
              "id": { "type": "string" }
            }
          },
          "claim_type": {
            "enum": [
              "eligibility_requirement",
              "document_requirement",
              "step",
              "fee",
              "processing_time",
              "rule",
              "condition",
              "definition",
              "location",
              "contact_info",
              "portal_link",
              "service_info",
              "operational_info",
              "portal_url",
              "other"
            ]
          },
          "text": {
            "type": "string",
            "minLength": 1
          },
          "structured_data": { "type": "object" },
          "citations": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["source_page_id", "quoted_text", "retrieved_at"],
              "properties": {
                "source_page_id": {
                  "type": "string",
                  "pattern": "^source\\.[a-f0-9]{40}$"
                },
                "quoted_text": {
                  "type": "string",
                  "minLength": 1
                },
                "locator": {
                  "oneOf": [
                    {
                      "type": "object",
                      "required": ["type", "heading_path"],
                      "properties": {
                        "type": { "const": "heading_path" },
                        "heading_path": {
                          "type": "array",
                          "items": { "type": "string" },
                          "minItems": 1
                        }
                      },
                      "additionalProperties": false
                    },
                    {
                      "type": "object",
                      "required": ["type", "css_selector"],
                      "properties": {
                        "type": { "const": "css_selector" },
                        "css_selector": { "type": "string" }
                      },
                      "additionalProperties": false
                    },
                    {
                      "type": "object",
                      "required": ["type", "xpath"],
                      "properties": {
                        "type": { "const": "xpath" },
                        "xpath": { "type": "string" }
                      },
                      "additionalProperties": false
                    },
                    {
                      "type": "object",
                      "required": ["type", "url_fragment"],
                      "properties": {
                        "type": { "const": "url_fragment" },
                        "url_fragment": { "type": "string" }
                      },
                      "additionalProperties": false
                    },
                    {
                      "type": "object",
                      "required": ["type", "pdf_page"],
                      "properties": {
                        "type": { "const": "pdf_page" },
                        "pdf_page": { "type": "integer", "minimum": 1 }
                      },
                      "additionalProperties": false
                    }
                  ]
                },
                "retrieved_at": {
                  "type": "string",
                  "format": "date-time"
                },
                "language": { "enum": ["bn", "en"] }
              }
            }
          },
          "status": {
            "enum": ["verified", "unverified", "stale", "deprecated", "contradicted"]
          },
          "last_verified_at": { "type": "string", "format": "date-time" },
          "last_verified_source_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
          "stale_marked_at": { "type": "string", "format": "date-time" },
          "stale_due_to_source_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
          "previous_status": {
            "enum": ["verified", "unverified", "stale", "deprecated", "contradicted"]
          },
          "tags": { "type": "array", "items": { "type": "string" } },
          "notes": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "agencies": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["agency_id", "name", "domain_allowlist"],
        "properties": {
          "agency_id": {
            "type": "string",
            "pattern": "^agency\\.[a-z0-9_]+$"
          },
          "name": { "type": "string" },
          "short_name": { "type": "string" },
          "website": { "type": "string", "format": "uri" },
          "domain_allowlist": {
            "type": "array",
            "items": { "type": "string" },
            "minItems": 1
          },
          "claims": {
            "type": "array",
            "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" }
          }
        }
      }
    },
    "documents": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["document_id", "document_name", "claims"],
        "properties": {
          "document_id": {
            "type": "string",
            "pattern": "^doc\\.[a-z0-9_]+$"
          },
          "document_name": { "type": "string" },
          "issued_by": {
            "type": "string",
            "pattern": "^agency\\.[a-z0-9_]+$"
          },
          "claims": {
            "type": "array",
            "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" },
            "minItems": 1
          },
          "status": {
            "enum": ["verified", "partial", "unverified", "stale", "deprecated", "contradicted"]
          },
          "last_updated_at": { "type": "string", "format": "date-time" }
        }
      }
    },
    "services": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "service_id",
          "service_name",
          "agency_id",
          "claims",
          "portal_mapping",
          "official_entrypoints"
        ],
        "properties": {
          "service_id": {
            "type": "string",
            "pattern": "^svc\\.[a-z0-9_]+$"
          },
          "service_name": { "type": "string" },
          "service_family": { "type": "string" },
          "agency_id": {
            "type": "string",
            "pattern": "^agency\\.[a-z0-9_]+$"
          },
          "claims": {
            "type": "array",
            "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" },
            "minItems": 1
          },
          "portal_mapping": {
            "type": "object",
            "required": ["entry_urls"],
            "properties": {
              "entry_urls": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["url", "source_page_id"],
                  "properties": {
                    "url": { "type": "string", "format": "uri" },
                    "source_page_id": { "type": "string", "pattern": "^source\\.[a-f0-9]{40}$" },
                    "description": { "type": "string" }
                  }
                },
                "minItems": 1
              },
              "portal_steps": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["order", "claim_id"],
                  "properties": {
                    "order": { "type": "integer", "minimum": 1 },
                    "claim_id": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" },
                    "fragile": { "type": "boolean" },
                    "notes": { "type": "array", "items": { "type": "string" } }
                  }
                }
              },
              "field_mappings": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "canonical_field": { "type": "string" },
                    "portal_label_bn": { "type": "string" },
                    "portal_label_en": { "type": "string" },
                    "claim_id": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" }
                  }
                }
              }
            }
          },
          "official_entrypoints": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["source_page_id"],
              "properties": {
                "source_page_id": { "type": "string", "pattern": "^source\\.[a-f0-9]{40}$" },
                "description": { "type": "string" }
              }
            },
            "minItems": 1
          },
          "document_requirements": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["document_id", "requirement_type"],
              "properties": {
                "document_id": { "type": "string", "pattern": "^doc\\.[a-z0-9_]+$" },
                "requirement_type": { "enum": ["required", "conditional", "optional"] },
                "condition_claim_id": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+$" }
              }
            }
          },
          "status": {
            "enum": ["verified", "partial", "unverified", "stale", "deprecated", "contradicted"]
          },
          "last_updated_at": { "type": "string", "format": "date-time" }
        }
      }
    },
    "service_guides": {
      "type": "array",
      "description": "Guide layer: user-friendly, step-by-step service guides that reference claims for provenance",
      "items": {
        "type": "object",
        "required": [
          "guide_id",
          "service_id",
          "agency_id",
          "title",
          "official_links"
        ],
        "properties": {
          "guide_id": {
            "type": "string",
            "pattern": "^guide\\.[a-z0-9_]+$",
            "description": "Unique guide ID, typically guide.<service_id_slug>"
          },
          "service_id": {
            "type": "string",
            "pattern": "^svc\\.[a-z0-9_]+$",
            "description": "Reference to the service this guide is for"
          },
          "agency_id": {
            "type": "string",
            "pattern": "^agency\\.[a-z0-9_]+$",
            "description": "Agency responsible for this service"
          },
          "title": {
            "type": "string",
            "minLength": 1,
            "description": "Human-readable title for the guide"
          },
          "overview": {
            "type": "string",
            "description": "Optional brief overview of the service"
          },
          "sections": {
            "type": "object",
            "description": "Categorized content sections",
            "properties": {
              "application_steps": {
                "type": "array",
                "description": "Ordered steps to complete the application",
                "items": { "$ref": "#/definitions/guide_step" }
              },
              "required_documents": {
                "type": "array",
                "description": "Documents required for the application",
                "items": { "$ref": "#/definitions/guide_item" }
              },
              "fees": {
                "type": "array",
                "description": "Fee information",
                "items": { "$ref": "#/definitions/guide_item" }
              },
              "processing_time": {
                "type": "array",
                "description": "Processing time information",
                "items": { "$ref": "#/definitions/guide_item" }
              },
              "eligibility": {
                "type": "array",
                "description": "Eligibility requirements",
                "items": { "$ref": "#/definitions/guide_item" }
              },
              "portal_links": {
                "type": "array",
                "description": "Portal URLs and links",
                "items": { "$ref": "#/definitions/guide_item" }
              },
              "service_info": {
                "type": "array",
                "description": "General service information (catch-all)",
                "items": { "$ref": "#/definitions/guide_item" }
              }
            }
          },
          "steps": {
            "type": "array",
            "description": "Shorthand for sections.application_steps - ordered steps to complete the service",
            "items": { "$ref": "#/definitions/guide_step" }
          },
          "variants": {
            "type": "array",
            "description": "Service variants (e.g., regular/express/super_express)",
            "items": {
              "type": "object",
              "required": ["variant_id", "label"],
              "properties": {
                "variant_id": {
                  "type": "string",
                  "description": "Variant identifier (e.g., 'regular', 'express', 'super_express')"
                },
                "label": {
                  "type": "string",
                  "description": "Human-readable label"
                },
                "fee_claim_ids": {
                  "type": "array",
                  "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$" },
                  "description": "Claim IDs for fees applicable to this variant"
                },
                "processing_time_claim_ids": {
                  "type": "array",
                  "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$" },
                  "description": "Claim IDs for processing times for this variant"
                }
              }
            }
          },
          "required_documents": {
            "type": "array",
            "description": "Shorthand for sections.required_documents",
            "items": { "$ref": "#/definitions/guide_item" }
          },
          "fees": {
            "type": "array",
            "description": "Shorthand for sections.fees",
            "items": { "$ref": "#/definitions/guide_item" }
          },
          "official_links": {
            "type": "array",
            "description": "Official portal links for this service",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["label", "url"],
              "properties": {
                "label": {
                  "type": "string",
                  "description": "Display label (e.g., 'Official Portal', 'Fee Schedule')"
                },
                "url": {
                  "type": "string",
                  "format": "uri",
                  "description": "Official URL"
                },
                "source_page_id": {
                  "type": "string",
                  "pattern": "^source\\.[a-f0-9]{40}$",
                  "description": "Optional reference to source_pages registry"
                }
              }
            }
          },
          "last_updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When this guide was last updated"
          },
          "generated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When this guide was auto-generated (if applicable)"
          },
          "status": {
            "enum": ["draft", "published", "archived"],
            "description": "Publication status of the guide"
          }
        }
      }
    },
    "enums": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "array",
          "items": { "enum": ["online", "offline", "hybrid", "n/a"] }
        },
        "status": {
          "type": "array",
          "items": { "enum": ["verified", "partial", "unverified", "stale", "deprecated", "contradicted"] }
        },
        "guide_status": {
          "type": "array",
          "items": { "enum": ["draft", "published", "archived"] }
        }
      }
    }
  },
  "definitions": {
    "guide_step": {
      "type": "object",
      "required": ["step_number", "title"],
      "properties": {
        "step_number": {
          "type": "integer",
          "minimum": 1,
          "description": "Step order (1-indexed)"
        },
        "title": {
          "type": "string",
          "description": "Step title"
        },
        "description": {
          "type": "string",
          "description": "Step description/instructions"
        },
        "claim_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$" },
          "description": "Claims that back this step"
        }
      }
    },
    "guide_item": {
      "type": "object",
      "required": ["label"],
      "properties": {
        "label": {
          "type": "string",
          "description": "Display label"
        },
        "description": {
          "type": "string",
          "description": "Optional description or details"
        },
        "claim_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^claim\\.[a-z0-9_]+(\\.[a-z0-9_]+)*$" },
          "description": "Claims that back this item"
        }
      }
    }
  },
  "additionalProperties": false
}

